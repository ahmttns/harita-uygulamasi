<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Durak Haritası</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root {
      --bg: #f9f9f9;
      --fg: #1e1e1e;
      --panel: #ffffff;
      --primary: #007bff;
    }
    body.dark-mode {
      --bg: #1e1e1e;
      --fg: #f9f9f9;
      --panel: #2c2c2c;
      --primary: #3399ff;
    }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    #panel {
      position: absolute;
      top: 60px;
      left: 10px;
      z-index: 1000;
      background: var(--panel);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      width: 280px;
      max-width: 90%;
      transition: all 0.3s ease;
    }
    input, select, button {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      background-color: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    button:hover {
      opacity: 0.9;
    }
    h3, h4 {
      margin-top: 0;
      font-size: 16px;
    }
    #topButtons {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1100;
      display: flex;
      gap: 8px;
    }
    #topButtons button {
      padding: 6px 12px;
      border-radius: 6px;
      background-color: var(--primary);
      color: white;
      font-size: 13px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    #topButtons button:hover {
      background-color: #0056b3;
    }
    @media screen and (max-width: 600px) {
      #panel {
        width: calc(100vw - 40px);
        left: 10px;
        right: 10px;
        top: 10px;
      }
      #panelToggleBtn {
        left: 200px !important;
      }
    }
  </style>
</head>
<body>
  <div id="topButtons">
    <button id="themeToggleBtn">🌙 Koyu Mod</button>
    <button id="panelToggleBtn">⬅️ Paneli Gizle</button>
  </div>

  <div id="panel">
    <button onclick="tumDuraklariGoster()">🗺️ Tüm Durakları Göster</button>
    <label>Durak Tipi:
      <select id="filtreDurakTipi"><option value="">Tümü</option></select>
    </label>
    <label>İlçe:
      <select id="filtreIlce"><option value="">Hepsi</option></select>
    </label>
    <h3>📍 Arama</h3>
    <input type="text" id="durakKodu" placeholder="Durak Kodu" />
    <button onclick="duragaGit()">🔍 Durak Koduyla Git</button>
    <input type="text" id="lat" value="41.0663" placeholder="Enlem" />
    <input type="text" id="lon" value="28.9960" placeholder="Boylam" />
    <input type="number" id="radius" value="300" placeholder="Yarıçap (m)" />
    <button onclick="koordinatlaAra()">📍 Koordinata Git ve Ara</button>
    <button onclick="secimleriTemizle()">🧹 Seçimleri Temizle</button>
    <h4>📌 <span id="adet">0</span> sonuç</h4>
    <ul id="sonuclar" style="max-height: 100px; overflow-y: auto; padding-left: 20px;"></ul>
    <button onclick="excelAktar()">📁 Sonuçları Excel'e Aktar</button>
  </div>

  <div id="map"></div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
   let duraklar = [];
  let seciliDurak = null;
  let seciliDurakMarker = null;  // ← Buraya ekle
  let markers = [];
  let circle = null;
  let duraklarGosterildi = false;

    const map = L.map('map', { zoomControl: false }).setView([41.0663, 28.9960], 13);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const clusterGroup = L.markerClusterGroup();
    map.addLayer(clusterGroup);

   fetch("durak_verisi.json")
  .then(res => {
    if (!res.ok) throw new Error("Dosya yüklenemedi: " + res.status);
    return res.json();
  })
  .then(data => {
    console.log("Durak verisi yüklendi:", data);
    duraklar = data;

    // Filtreler için setler oluştur
    const tipSet = new Set();
    const ilceSet = new Set();

    duraklar.forEach(d => {
      if(d["Durak Tipi"]) tipSet.add(d["Durak Tipi"]);
      if(d["Durak İlçe"]) ilceSet.add(d["Durak İlçe"]);
    });

    const tipSelect = document.getElementById("filtreDurakTipi");
    const ilceSelect = document.getElementById("filtreIlce");

    tipSet.forEach(tip => {
      const opt = document.createElement("option");
      opt.value = tip;
      opt.textContent = tip;
      tipSelect.appendChild(opt);
    });

    ilceSet.forEach(ilce => {
      const opt = document.createElement("option");
      opt.value = ilce;
      opt.textContent = ilce;
      ilceSelect.appendChild(opt);
    });
  })
  .catch(err => {
    console.error("Fetch hatası:", err);
    alert("Durak verisi yüklenemedi! " + err.message);
  });

    // Panel göster/gizle
    const panel = document.getElementById("panel");
    const panelToggleBtn = document.getElementById("panelToggleBtn");
    let panelVisible = true;
    panelToggleBtn.addEventListener("click", () => {
      panelVisible = !panelVisible;
      panel.style.display = panelVisible ? "block" : "none";
      panelToggleBtn.textContent = panelVisible ? "⬅️ Paneli Gizle" : "➡️ Paneli Göster";
    });

    // Koyu mod / açık mod
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    themeToggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      themeToggleBtn.textContent = isDark ? "🌞 Açık Mod" : "🌙 Koyu Mod";
    });

    // Tüm durakları göster (filtreli)
    function tumDuraklariGoster() {
      if(duraklar.length === 0) {
        alert("Durak verisi henüz yüklenmedi!");
        return;
      }

      if(duraklarGosterildi) {
        clusterGroup.clearLayers();
        duraklarGosterildi = false;
        return;
      }

      clusterGroup.clearLayers();

      const secilenTip = document.getElementById("filtreDurakTipi").value;
      const secilenIlce = document.getElementById("filtreIlce").value;

      const filtrelenmisDuraklar = duraklar.filter(d => {
        const tipUyar = !secilenTip || d["Durak Tipi"] === secilenTip;
        const ilceUyar = !secilenIlce || d["Durak İlçe"] === secilenIlce;
        return tipUyar && ilceUyar;
      });

      filtrelenmisDuraklar.forEach(durak => {
        const lat = parseFloat(durak.boylam);
        const lon = parseFloat(durak.enlem);
        if(!lat || !lon) return;

        const marker = L.marker([lat, lon])
          .bindPopup(`
            <b>${durak["Durak Adı"]}</b><br>
            Kodu: ${durak["Durak Kodu"]}<br>
            İlçe: ${durak["Durak İlçe"] || "-"}<br>
            Mahalle: ${durak["Durak Mahalle"] || "-"}<br>
            Yolcu: ${durak["Günlük Ortalama Yolcu Sayısı"] || "-"}
          `)
          .on("click", () => {
            document.getElementById("durakKodu").value = durak["Durak Kodu"];
            document.getElementById("lat").value = lat;
            document.getElementById("lon").value = lon;
          });

        clusterGroup.addLayer(marker);
      });

      map.setView([41.0663, 28.9960], 13);
      duraklarGosterildi = true;
    }

    
   function duragaGit() {
  const kod = document.getElementById("durakKodu").value.trim().toLowerCase();
  const durak = duraklar.find(d => d["Durak Kodu"] && d["Durak Kodu"].toString().trim().toLowerCase() === kod);
  if (!durak) {
    alert("Durak kodu bulunamadı!");
    return;
  }
  if (seciliDurakMarker) {
    map.removeLayer(seciliDurakMarker);
  }
  seciliDurak = durak;

  const lat = parseFloat(durak.boylam); // enlem
  const lon = parseFloat(durak.enlem); // boylam
  if (!lat || !lon) {
    alert("Koordinatlar eksik!");
    return;
  }

  seciliDurakMarker = L.marker([lat, lon]).addTo(map)
    .bindPopup(`<b>${durak["Durak Adı"]}</b><br>İlçe: ${durak["Durak İlçe"]}`)
    .openPopup();

  map.setView([lat, lon], 17);

  document.getElementById("lat").value = lat;
  document.getElementById("lon").value = lon;
}
    function koordinatlaAra() {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      const radius = parseInt(document.getElementById("radius").value);

      if(isNaN(lat) || isNaN(lon) || isNaN(radius)) {
        alert("Geçerli koordinat ve yarıçap giriniz!");
        return;
      }

      if(circle) {
        map.removeLayer(circle);
      }
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      map.setView([lat, lon], 16);
      circle = L.circle([lat, lon], { radius: radius, color: 'blue', fillOpacity: 0.1 }).addTo(map);

      const query = `
[out:json][timeout:25];
(
  node["amenity"="hospital"](around:${radius},${lat},${lon});
  node["amenity"="clinic"](around:${radius},${lat},${lon});
  node["amenity"="school"](around:${radius},${lat},${lon});
  node["amenity"="university"](around:${radius},${lat},${lon});
  node["shop"="mall"](around:${radius},${lat},${lon});
  node["tourism"="museum"](around:${radius},${lat},${lon});
  node["station"="subway"](around:${radius},${lat},${lon});
);
out center;
`;

      fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
      })
      .then(res => res.json())
      .then(data => {
        let count = 0;
        data.elements.forEach(e => {
          const elat = e.lat || e.center?.lat;
          const elon = e.lon || e.center?.lon;
          if(!elat || !elon) return;

          const isim = e.tags.name || "İsimsiz Yer";
          const kategori = e.tags.amenity || e.tags.shop || e.tags.tourism || e.tags.station || "Kategori Yok";

          if(["fuel", "bicycle_parking", "parking"].includes(kategori)) return;

          const renk = {
            hospital: "red",
            school: "green",
            mall: "purple",
            university: "orange",
            museum: "teal"
          }[kategori] || "blue";

          const marker = L.circleMarker([elat, elon], {
            radius: 8,
            fillColor: renk,
            fillOpacity: 0.8,
            color: "#000",
            weight: 1
          }).addTo(map);

          marker.bindPopup(`<b>${isim}</b><br>${kategori}`);
          markers.push(marker);

          const li = document.createElement("li");
          li.textContent = `${isim} (${kategori})`;
          document.getElementById("sonuclar").appendChild(li);
          count++;
        });

        document.getElementById("adet").textContent = count;
      })
      .catch(() => alert("Veri alınırken hata oluştu"));
    }

    // Sonuçları Excel'e aktarma
    function excelAktar() {
      if(!seciliDurak) {
        alert("Lütfen önce bir durak arayın!");
        return;
      }
      if(markers.length === 0) {
        alert("Henüz veri bulunamadı!");
        return;
      }

      const rows = [
        ["Durak Kodu", "Durak Adı", "Durak Tipi", "İlçe", "Mahalle", "Yolcu Sayısı", "Yer İsmi", "Kategori"]
      ];

      markers.forEach((m, index) => {
        const popup = m.getPopup().getContent();
        const [isimSatir, kategoriSatir] = popup.split("<br>");
        const isim = isimSatir.replace(/<[^>]*>/g, "").trim();
        const kategori = kategoriSatir ? kategoriSatir.replace(/<[^>]*>/g, "").trim() : "Kategori Yok";

        rows.push([
          index === 0 ? seciliDurak["Durak Kodu"] : "",
          index === 0 ? seciliDurak["Durak Adı"] : "",
          index === 0 ? seciliDurak["Durak Tipi"] : "",
          index === 0 ? seciliDurak["Durak İlçe"] : "",
          index === 0 ? seciliDurak["Durak Mahalle"] : "",
          index === 0 ? seciliDurak["Günlük Ortalama Yolcu Sayısı"] : "",
          isim,
          kategori
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Sonuclar");

      const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const blob = new Blob([wbout], { type: "application/octet-stream" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `durak_sonuclari_${seciliDurak["Durak Kodu"]}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Seçimleri temizle
    function secimleriTemizle() {
      document.getElementById("durakKodu").value = "";
      document.getElementById("lat").value = "41.0663";
      document.getElementById("lon").value = "28.9960";
      document.getElementById("radius").value = 300;

      document.getElementById("sonuclar").innerHTML = "";
      document.getElementById("adet").textContent = "0";

      if(circle) {
        map.removeLayer(circle);
        circle = null;
      }
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      if(seciliDurakMarker) {
        map.removeLayer(seciliDurakMarker);
        seciliDurakMarker = null;
      }

      clusterGroup.clearLayers();
      duraklarGosterildi = false;

      map.setView([41.0663, 28.9960], 13);
      seciliDurak = null;
    }

  </script>
</body>
</html>